#!/usr/bin/env bash

set -Eeuo pipefail

red='\033[0;31m'
green='\033[0;32m'
yellow='\033[0;33m'
nc='\033[0m'

# Get dotfiles dir (so run this script from anywhere)
export dotfiles_dir
dotfiles_dir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && cd .. && pwd )"

help() {
    echo "Dotfiles management"
    echo
    echo -e "Usage: ${yellow}$0 <command>${nc}"
    echo
    echo "Commands:"
    echo " help:    This help message"
    echo " update:  Update dotfiles"
    echo " edit:    Open dotfiles directory for editing"
    echo
}

pull_dotfiles() {
    cd "$dotfiles_dir"
    if ! out=$(2>&1 git pull --all --prune --rebase); then
        echo -e "${red}Error updating dotfiles checkout. Fix it and run update again${nc}"
        echo "Output:"
        echo "$out"
        exit 1;
    fi
}

update() {
    pull_dotfiles
    echo -e "${green}Success! Dotfiles updated${nc}"
}

if [[ $# -eq 0 ]]; then
    help
    exit 0
fi

case $1 in
    "" | "help" | "-h" | "--help")
        help
        ;;
    "edit")
        exec "${EDITOR:-vim}" "$dotfiles_dir"
        ;;
    "update")
        update
        ;;
    *)
        >&2 echo -e "${red}Error: '$command_name' is not a known command${nc}"
        help
        exit 1
        ;;
esac